<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Syntax Fix Test</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .mermaid-rendered {
            display: block;
            text-align: center;
            margin: 1rem 0;
        }
        .mermaid-rendered svg {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Mermaid Syntax Fix Test</h1>
    
    <h2>Original (Broken) Syntax:</h2>
    <pre id="original"></pre>
    
    <h2>Fixed Syntax:</h2>
    <pre id="fixed"></pre>
    
    <h2>Rendered Diagram:</h2>
    <div class="mermaid" id="diagram"></div>

    <script>
        // Test the syntax fixing function
        function fixMermaidSyntax(mermaidCode) {
            let fixed = mermaidCode.trim();
            
            // Fix 1: Ensure proper diagram type declaration
            if (!fixed.startsWith('flowchart') && !fixed.startsWith('graph') && !fixed.startsWith('sequenceDiagram') && !fixed.startsWith('classDiagram')) {
                if (fixed.includes('-->') || fixed.includes('--') || fixed.includes('subgraph')) {
                    fixed = 'flowchart TD\n' + fixed;
                }
            }
            
            // Fix 2: Fix incomplete arrows (arrows without destinations)
            fixed = fixed.replace(/-->\s*$/gm, ''); // Remove arrows at end of lines
            fixed = fixed.replace(/--\s*$/gm, ''); // Remove double dashes at end of lines
            
            // Fix 3: Fix malformed arrows
            fixed = fixed.replace(/-->\s*-->/g, '-->'); // Fix double arrows
            fixed = fixed.replace(/--\s*-->/g, '-->'); // Fix mixed arrow types
            
            // Fix 4: Ensure proper subgraph syntax
            fixed = fixed.replace(/subgraph\s+(\w+)\s*\[/g, 'subgraph $1[');
            fixed = fixed.replace(/subgraph\s+(\w+)\s*\(/g, 'subgraph $1(');
            
            // Fix 5: Fix classDef placement (should be at the end)
            const classDefLines = fixed.split('\n').filter(line => line.trim().startsWith('classDef'));
            const nonClassDefLines = fixed.split('\n').filter(line => !line.trim().startsWith('classDef'));
            
            if (classDefLines.length > 0) {
                fixed = nonClassDefLines.join('\n') + '\n' + classDefLines.join('\n');
            }
            
            // Fix 6: Fix class applications (should be after classDef)
            const classLines = fixed.split('\n').filter(line => line.trim().includes(':::'));
            const nonClassLines = fixed.split('\n').filter(line => !line.trim().includes(':::'));
            
            if (classLines.length > 0) {
                fixed = nonClassLines.join('\n') + '\n' + classLines.join('\n');
            }
            
            // Fix 7: Remove empty lines and normalize
            fixed = fixed.split('\n').filter(line => line.trim()).join('\n');
            
            // Fix 8: Ensure proper indentation
            const lines = fixed.split('\n');
            const fixedLines = lines.map(line => {
                if (line.trim().startsWith('subgraph')) {
                    return '  ' + line.trim();
                } else if (line.trim().startsWith('end')) {
                    return '  ' + line.trim();
                } else if (line.trim().includes('-->') || line.trim().includes('--')) {
                    return '    ' + line.trim();
                } else if (line.trim().startsWith('classDef')) {
                    return line.trim();
                } else if (line.trim().includes(':::')) {
                    return line.trim();
                }
                return line.trim();
            });
            
            fixed = fixedLines.join('\n');
            
            console.log('Mermaid syntax fixed:', fixed.substring(0, 200) + '...');
            return fixed;
        }

        // Test with broken syntax
        const brokenSyntax = `LB --> API_GW
API_GW --> Todo_Service
Todo_Service --> DB
Todo_Service -- Read-heavy Lists --> Cache
API_GW --> Cache -- Auth Tokens -->
classDef client fill:#e1f5fe, stroke:#01579b,color:#000
classDef lb fill:#fff3e0,stroke: #e65100,color:#000
classDef gateway fill:#e8f5e8, stroke:#1b5e20,color:#000
classDef service fill:#fff8e1, stroke:#f57f17,color:#000
classDef db fill:#e3f2fd, stroke:#0d47a1,color:#000
classDef cache fill:#fff3e0,stroke:#f57c00,color:#000`;

        document.getElementById('original').textContent = brokenSyntax;
        
        const fixedSyntax = fixMermaidSyntax(brokenSyntax);
        document.getElementById('fixed').textContent = fixedSyntax;
        
        // Set the fixed syntax in the diagram
        document.getElementById('diagram').textContent = fixedSyntax;
        
        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });
        
        // Try to render the fixed diagram
        setTimeout(() => {
            try {
                const id = 'test-diagram';
                mermaid.render(id, fixedSyntax).then(({ svg }) => {
                    document.getElementById('diagram').innerHTML = svg;
                    console.log('Diagram rendered successfully!');
                }).catch(error => {
                    console.error('Diagram render failed:', error);
                    document.getElementById('diagram').innerHTML = '<p style="color: red;">Render failed: ' + error.message + '</p>';
                });
            } catch (error) {
                console.error('Diagram processing failed:', error);
                document.getElementById('diagram').innerHTML = '<p style="color: red;">Processing failed: ' + error.message + '</p>';
            }
        }, 100);
    </script>
</body>
</html>
