<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complex Mermaid Test</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .mermaid-rendered {
            display: block;
            text-align: center;
            margin: 1rem 0;
        }
        .mermaid-rendered svg {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>Complex Mermaid Diagram Test</h1>
    
    <div class="mermaid">
flowchart TD
subgraph Perception[Perception Layer]
  LIDAR[LiDAR/Sensor Array]:::sensor
  IMU[IMU/Odometry]:::sensor
end
subgraph Cognition[Cognition Layer (Onboard CPU)]
  SLAM[SLAM Module (Localization & Mapping)]:::algo
  MapDB[(Occupancy Grid/Map State)]:::db
  GlobalPlanner[Global Path Planner (Coverage)]:::algo
end
subgraph Action[Action Layer]
  LocalPlanner[Local Motion Planner (Avoidance)]:::control
  MotorController[Motor/Actuator Interface]:::control
end
  LIDAR & IMU --> SLAM
  SLAM --> MapDB
  SLAM --> GlobalPlanner
  MapDB --> GlobalPlanner
  GlobalPlanner --> LocalPlanner
  LocalPlanner --> MotorController
  SLAM -- Real-time Pose Update --> LocalPlanner
  MotorController --> Robot_Movement[Robot Movement]
classDef sensor fill:#e1f5fe,stroke:#01579b,color:#000
  classDef algo fill:#fff8e1,stroke:#f57f17,color:#000
  classDef db fill:#e8f5e8,stroke:#1b5e20,color:#000
  classDef control fill:#fff3e0,stroke:#e65100,color:#000
    </div>

    <script>
        // Test complex diagram processing
        function cleanSvgContent(svgContent) {
            let cleaned = svgContent
                .replace(/aria-roledescription="[^"]*"/g, '')
                .replace(/role="graphics-document[^"]*"/g, '')
                .replace(/\s+/g, ' ')
                .replace(/\s*=\s*/g, '=')
                .trim();
            
            cleaned = cleaned.replace(/aria-roledescription\s*=\s*"[^"]*"/g, '');
            cleaned = cleaned.replace(/role\s*=\s*"graphics-document[^"]*"/g, '');
            
            return cleaned;
        }

        function setSvgContentSafely(element, svgContent) {
            element.classList.remove('mermaid');
            element.classList.add('mermaid-rendered');
            element.dataset.processed = '1';
            
            const originalMermaid = window.mermaid;
            window.mermaid = null;
            
            element.innerHTML = svgContent;
            
            setTimeout(() => {
                window.mermaid = originalMermaid;
            }, 200);
        }

        // Initialize Mermaid
        mermaid.initialize({ startOnLoad: false, theme: 'default', securityLevel: 'loose' });

        // Process the complex diagram
        setTimeout(() => {
            const nodes = document.querySelectorAll('.mermaid');
            console.log('Found', nodes.length, 'Mermaid nodes');
            
            nodes.forEach((el, i) => {
                if (el.dataset.processed === '1') return;
                
                const src = el.textContent || '';
                console.log('Processing complex diagram node', i, ':', src.substring(0, 100) + '...');
                
                // Check if it's a complex diagram
                const isComplex = src.includes('subgraph') || src.includes('classDef') || src.includes('class ') || src.includes(':::');
                console.log('Complex diagram detected:', isComplex);
                
                if (isComplex) {
                    console.log('Using original syntax for complex diagram');
                    // For complex diagrams, use the original syntax
                    const normalizedSrc = src;
                    console.log('Normalized source:', normalizedSrc.substring(0, 200) + '...');
                    
                    // Try to render with Mermaid
                    try {
                        const id = `mmd-${Date.now()}-${i}`;
                        mermaid.render(id, normalizedSrc).then(({ svg }) => {
                            console.log('Complex diagram rendered successfully');
                            const cleanedSvg = cleanSvgContent(svg);
                            setSvgContentSafely(el, cleanedSvg);
                        }).catch(error => {
                            console.error('Complex diagram render failed:', error);
                        });
                    } catch (error) {
                        console.error('Complex diagram processing failed:', error);
                    }
                }
            });
        }, 100);
    </script>
</body>
</html>
